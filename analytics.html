<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - OncoPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background: #1e293b; border: 1px solid #334155; }
        .selected-row { background: #334155 !important; border-left: 3px solid #10b981; }
        .chart-container { 
            position: relative; 
            height: 300px !important; 
            max-height: 300px !important;
        }
        canvas { 
            max-height: 300px !important; 
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <div class="text-2xl font-bold text-emerald-400">OncoPurpose</div>
                    <div class="hidden md:flex space-x-6">
                        <a href="index.html" class="text-gray-300 hover:text-white transition-colors">Home</a>
                        <a href="dashboard.html" class="text-gray-300 hover:text-white transition-colors">Dashboard</a>
                        <a href="discovery.html" class="text-gray-300 hover:text-white transition-colors">Discovery</a>
                        <a href="library_live.html" class="text-gray-300 hover:text-white transition-colors">Research</a>
                        <a href="analytics.html" class="text-white transition-colors">Analytics</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="text" placeholder="Search..." 
                        class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 w-64 focus:outline-none focus:border-emerald-500 text-sm">
                    <img src="resources/user avtars/exec2 (1).png" alt="User" class="w-8 h-8 rounded-full">
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-24 p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">Portfolio Analytics</h1>
                <p class="text-gray-400">Comprehensive analysis dashboard for all repurposing opportunities</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-sm text-gray-400 mb-1">Avg Success Rate</div>
                    <div class="text-3xl font-bold" id="avg-success">68.4%</div>
                    <div class="text-xs text-red-400 mt-1">-3% QTD</div>
                </div>
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-sm text-gray-400 mb-1">Total Reports</div>
                    <div class="text-3xl font-bold text-emerald-400" id="total-reports">0</div>
                </div>
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-sm text-gray-400 mb-1">Avg Timeline</div>
                    <div class="text-3xl font-bold text-yellow-400" id="avg-timeline">3.7 yrs</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid lg:grid-cols-2 gap-6 mb-8">
                <!-- Success Probability Chart -->
                <div class="glass-card p-6 rounded-xl">
                    <div class="mb-4">
                        <h2 class="text-xl font-semibold mb-1">Success Probability Distribution</h2>
                        <p class="text-xs text-gray-400">Showing <span id="opportunity-count">0</span> opportunities</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="successChart"></canvas>
                    </div>
                </div>

                <!-- Market Opportunity Matrix -->
                <div class="glass-card p-6 rounded-xl">
                    <div class="mb-4">
                        <h2 class="text-xl font-semibold">Market Opportunity Matrix</h2>
                        <p class="text-xs text-gray-400">Size vs. Confidence</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="marketChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Timeline Chart -->
            <div class="glass-card p-6 rounded-xl mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Development Timeline Projections</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportAnalyticsReport()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm">üìä Export Report</button>
                        <button onclick="shareDashboard()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">üì§ Share Dashboard</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="p-6 border-b border-slate-700">
                    <h2 class="text-xl font-semibold">Top Performing Opportunities</h2>
                    <p class="text-sm text-gray-400 mt-1">(click any row to update charts above)</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full" id="opportunities-table">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Drug Name</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Target Cancer</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Confidence Score</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Market Size</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Success Probability</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Timeline</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">ROI</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Market Report</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-700">
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center text-gray-400">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <div>No analysis reports yet. <a href="discovery.html" class="text-emerald-400 underline">Create your first analysis</a></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let successChart, marketChart, timelineChart;
        let allReports = [];
        let selectedReport = null;

        // Load reports from localStorage
        function loadReports() {
            allReports = JSON.parse(localStorage.getItem('userAnalysisResults') || '[]');
            
            if (allReports.length === 0) {
                return;
            }

            // Update stats
            document.getElementById('total-reports').textContent = allReports.length;
            document.getElementById('opportunity-count').textContent = allReports.length;
            
            const avgConf = allReports.reduce((sum, r) => sum + (r.confidence_score || 0), 0) / allReports.length;
            document.getElementById('avg-success').textContent = (avgConf * 100).toFixed(1) + '%';

            // Render table
            renderTable();
            
            // Render charts with ALL data
            renderChartsAll();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('table-body');
            
            if (allReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-400">
                            <div class="text-4xl mb-2">üìä</div>
                            <div>No analysis reports yet. <a href="discovery.html" class="text-emerald-400 underline">Create your first analysis</a></div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allReports.map((report, index) => {
                const conf = (report.confidence_score || 0) > 1 ? report.confidence_score : (report.confidence_score || 0) * 100;
                const market = extractMarketSize(report.market_potential);
                const timeline = extractYears(report.timeline);
                const roi = calculateROI(conf, market);
                
                return `
                    <tr class="hover:bg-slate-700/30 transition-colors cursor-pointer" 
                        onclick="selectReport(${index})" 
                        id="row-${index}">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-slate-700 rounded-lg mr-3 flex items-center justify-center text-2xl">üíä</div>
                                <span class="font-medium">${report.drug_name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-300">${report.cancer_type}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-20 bg-gray-700 rounded-full h-2 mr-2">
                                    <div class="bg-emerald-500 h-2 rounded-full" style="width: ${conf}%"></div>
                                </div>
                                <span class="text-sm text-emerald-400">${conf.toFixed(0)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-green-400">$${market}B</td>
                        <td class="px-6 py-4 text-teal-400">${(conf * 0.9).toFixed(0)}%</td>
                        <td class="px-6 py-4 text-emerald-400">${timeline} years</td>
                        <td class="px-6 py-4 text-yellow-400">${roi}%</td>
                        <td class="px-6 py-4">
                            <button onclick="event.stopPropagation(); generateMarketReport(${index})" 
                                    class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                üìÑ AI Report
                            </button>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="event.stopPropagation(); deleteReport(${index})" 
                                    class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Select report (update charts to show only this report)
        function selectReport(index) {
            selectedReport = index;
            
            // Highlight row
            document.querySelectorAll('#table-body tr').forEach(tr => tr.classList.remove('selected-row'));
            document.getElementById(`row-${index}`).classList.add('selected-row');
            
            // Update charts to show THIS report
            renderChartsSingle(allReports[index]);
        }

        // Render charts with ALL reports
        function renderChartsAll() {
            const ctx1 = document.getElementById('successChart').getContext('2d');
            const ctx2 = document.getElementById('marketChart').getContext('2d');
            const ctx3 = document.getElementById('timelineChart').getContext('2d');

            // Success Distribution (Bar Chart)
            if (successChart) successChart.destroy();
            successChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: allReports.map(r => r.drug_name),
                    datasets: [{
                        label: 'Confidence Score (%)',
                        data: allReports.map(r => ((r.confidence_score || 0) > 1 ? r.confidence_score : (r.confidence_score || 0) * 100)),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    }
                }
            });

            // Market Opportunity Matrix (Bubble Chart)
            if (marketChart) marketChart.destroy();
            marketChart = new Chart(ctx2, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Opportunities',
                        data: allReports.map(r => ({
                            x: extractMarketSize(r.market_potential),
                            y: ((r.confidence_score || 0) > 1 ? r.confidence_score : (r.confidence_score || 0) * 100),
                            r: 15
                        })),
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { 
                            title: { display: true, text: 'Confidence (%)', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            title: { display: true, text: 'Market Size ($B)', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const report = allReports[context.dataIndex];
                                    return `${report.drug_name}: ${context.parsed.y.toFixed(0)}% confidence, $${context.parsed.x}B market`;
                                }
                            }
                        }
                    }
                }
            });

            // Timeline Chart (Line Chart)
            if (timelineChart) timelineChart.destroy();
            timelineChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: allReports.map(r => r.drug_name),
                    datasets: [{
                        label: 'Timeline (years)',
                        data: allReports.map(r => extractYears(r.timeline)),
                        borderColor: 'rgba(251, 191, 36, 1)',
                        backgroundColor: 'rgba(251, 191, 36, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Years to Market', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#334155' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    }
                }
            });
        }

        // Render charts for SINGLE report
        function renderChartsSingle(report) {
            const conf = (report.confidence_score || 0) > 1 ? report.confidence_score : (report.confidence_score || 0) * 100;
            const market = extractMarketSize(report.market_potential);
            const timeline = extractYears(report.timeline);

            // Update success chart to show only this drug
            successChart.data.labels = [report.drug_name];
            successChart.data.datasets[0].data = [conf];
            successChart.update();

            // Update market chart
            marketChart.data.datasets[0].data = [{x: market, y: conf, r: 20}];
            marketChart.update();

            // Update timeline chart
            timelineChart.data.labels = [report.drug_name];
            timelineChart.data.datasets[0].data = [timeline];
            timelineChart.update();

            // Update opportunity count
            document.getElementById('opportunity-count').textContent = '1 (selected)';
        }

        // Delete report
        function deleteReport(index) {
            if (!confirm(`Delete report for ${allReports[index].drug_name}?`)) return;
            
            allReports.splice(index, 1);
            localStorage.setItem('userAnalysisResults', JSON.stringify(allReports));
            
            loadReports();
        }

        // Generate AI Market Report
        async function generateMarketReport(index) {
            const report = allReports[index];
            
            // Show loading notification
            const notification = document.createElement('div');
            notification.id = 'ai-notification';
            notification.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #3b82f6; color: white; padding: 16px 24px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">ü§ñ Generating AI Market Report...</div>
                <div style="font-size: 12px;">This may take 10-30 seconds</div>
            `;
            document.body.appendChild(notification);
            
            try {
                const response = await fetch('http://localhost:8000/api/reports/download-market-report-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        drug_name: report.drug_name,
                        cancer_type: report.cancer_type,
                        confidence_score: (report.confidence_score || 0) > 1 ? report.confidence_score : (report.confidence_score || 0) * 100,
                        mechanism: report.mechanism || '',
                        clinical_phase: report.clinical_phase || '',
                        market_potential: report.market_potential || ''
                    })
                });
                
                if (!response.ok) throw new Error('Report generation failed');
                
                // Download PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Market_Report_${report.drug_name}_${report.cancer_type}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                // Update notification
                notification.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">‚úÖ AI Report Generated!</div>
                    <div style="font-size: 12px;">PDF downloaded successfully</div>
                `;
                notification.style.background = '#10b981';
                setTimeout(() => notification.remove(), 3000);
                
            } catch (error) {
                console.error('Market report error:', error);
                notification.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">‚ùå Generation Failed</div>
                    <div style="font-size: 12px;">${error.message}</div>
                `;
                notification.style.background = '#ef4444';
                setTimeout(() => notification.remove(), 4000);
            }
        }

        // Helper functions
        function extractMarketSize(str) {
            if (!str) return 1.5;
            const match = str.match(/\$?([\d.]+)/);
            return match ? parseFloat(match[1]) : 1.5;
        }

        function extractYears(str) {
            if (!str) return 3.5;
            const match = str.match(/([\d.]+)/);
            return match ? parseFloat(match[1]) : 3.5;
        }

        function calculateROI(conf, market) {
            return Math.round(conf * market * 3);
        }

        // Export Analytics Report
        async function exportAnalyticsReport() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Exporting...';
            btn.disabled = true;
            
            try {
                if (allReports.length === 0) {
                    alert('No reports to export. Please generate some analysis first.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Create CSV content
                const headers = ['Drug Name', 'Cancer Type', 'Confidence Score', 'Market Potential', 'Timeline', 'ROI %'];
                const csvRows = [headers.join(',')];
                
                allReports.forEach(report => {
                    const row = [
                        report.drug_name || '',
                        report.cancer_type || '',
                        ((report.confidence_score || 0) > 1 ? report.confidence_score : (report.confidence_score || 0) * 100).toFixed(0) + '%',
                        report.market_potential || '',
                        report.timeline || '',
                        calculateROI(
                            (report.confidence_score || 0) > 1 ? report.confidence_score / 100 : (report.confidence_score || 0),
                            extractMarketValue(report.market_potential)
                        ) + '%'
                    ];
                    csvRows.push(row.map(cell => `"${cell}"`).join(','));
                });
                
                const csvContent = csvRows.join('\\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                btn.textContent = '‚úÖ Exported!';
                showNotification(`‚úÖ Analytics report exported! (${allReports.length} reports)`, 'success');
                setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
            } catch (error) {
                console.error('Error:', error);
                btn.textContent = '‚ùå Error';
                showNotification('‚ùå Failed to export report. Please try again.', 'error');
                setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
            }
        }
        
        // Share Dashboard
        async function shareDashboard() {
            const btn = event.target;
            const originalText = btn.textContent;
            
            const shareData = {
                title: 'OncoPurpose Analytics Dashboard',
                text: `Drug repurposing analytics: ${allReports.length} opportunities analyzed`,
                url: window.location.href
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    btn.textContent = '‚úÖ Shared!';
                    showNotification('‚úÖ Dashboard shared successfully!', 'success');
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                } else {
                    // Fallback: Copy to clipboard
                    const shareText = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    btn.textContent = '‚úÖ Link Copied!';
                    showNotification('‚úÖ Link copied to clipboard!', 'success');
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                }
            } catch (error) {
                console.error('Error sharing:', error);
                showNotification('‚ùå Could not share. Please try again.', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadReports);

        // Listen for storage changes (cross-page sync)
        window.addEventListener('storage', (e) => {
            if (e.key === 'userAnalysisResults') {
                loadReports();
            }
        });
        
        // Toast Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') {
                notification.style.background = '#10b981';
            } else if (type === 'error') {
                notification.style.background = '#ef4444';
            } else {
                notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>

